<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨çƒå¼€æºå¼€å‘è€… 3D å¯è§†åŒ–ç³»ç»Ÿ - ä¸“ä¸šåˆ†æç‰ˆ</title>
    <style>
        :root {
            --primary-color: #00f3ff;
            --secondary-color: #ff0055;
            --growth-color: #00ff88;
            --glass-bg: rgba(15, 23, 35, 0.75);
            --glass-border: 1px solid rgba(255, 255, 255, 0.15);
            --text-shadow: 0 0 10px rgba(0, 243, 255, 0.5);
            --panel-padding: 20px;
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: #050510;
            font-family: 'Segoe UI', 'Roboto', sans-serif;
            color: #eee;
        }

        #container {
            position: absolute;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, #1a1a2e 0%, #000000 100%);
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary-color); }

        /* é¢æ¿åŸºç¡€ */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: var(--glass-border);
            border-radius: 12px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            pointer-events: auto; 
        }

        #header {
            position: absolute;
            top: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            pointer-events: none;
            z-index: 10;
        }

        h1 {
            margin: 0;
            font-size: 28px;
            letter-spacing: 3px;
            text-transform: uppercase;
            background: linear-gradient(90deg, #fff, var(--primary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(0, 243, 255, 0.3);
        }

        /* è§†å›¾åˆ‡æ¢å™¨ */
        .view-switcher {
            display: inline-flex;
            background: rgba(0,0,0,0.5);
            border-radius: 20px;
            padding: 4px;
            margin-top: 10px;
            border: 1px solid rgba(255,255,255,0.1);
            pointer-events: auto;
        }

        .view-btn {
            background: transparent;
            border: none;
            color: #aaa;
            padding: 6px 16px;
            border-radius: 16px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: 0.3s;
        }

        .view-btn.active {
            background: var(--primary-color);
            color: #000;
            box-shadow: 0 0 10px var(--primary-color);
        }

        /* å·¦ä¾§é¢æ¿ */
        #leftPanel {
            position: absolute;
            top: 100px;
            left: 30px;
            width: 260px;
            z-index: 100;
            padding: var(--panel-padding);
        }

        /* å·¦ä¸‹è§’é¢æ¿ */
        #bottomLeftPanel {
            position: absolute;
            bottom: 30px;
            left: 30px;
            width: 300px;
            z-index: 90;
            padding: 15px;
        }

        .search-box { position: relative; margin-bottom: 20px; }
        .search-box input {
            width: 100%;
            padding: 12px 10px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: white;
            box-sizing: border-box;
            outline: none;
            transition: 0.3s;
        }
        .search-box input:focus { border-color: var(--primary-color); }
        
        .panel-section { margin-bottom: 20px; }
        .panel-title { 
            font-size: 14px; color: #8899a6; text-transform: uppercase; letter-spacing: 1px; 
            margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px;
        }

        /* æ•°æ®è¡¨æ ¼æ ·å¼ */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            margin-top: 5px;
        }
        .data-table th {
            text-align: left;
            color: #667788;
            font-weight: 600;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .data-table td {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            color: #ddd;
        }
        .data-table tr:last-child td { border-bottom: none; }
        .data-table .num {
            text-align: right;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }
        .trend-up { color: var(--growth-color); }
        .trend-neutral { color: #aaa; }

        /* å³ä¾§é¢æ¿ (åˆ†æä»ªè¡¨ç›˜) */
        #rightPanel {
            position: absolute;
            top: 100px;
            right: 30px;
            width: 320px;
            max-height: calc(100vh - 140px);
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
            transform: translateX(360px); /* é»˜è®¤éšè— */
            opacity: 0;
        }

        #rightPanel.active {
            transform: translateX(0);
            opacity: 1;
        }

        /* æ’è¡Œæ¦œé¢æ¿ (é»˜è®¤æ˜¾ç¤º) */
        #rankPanel {
            position: absolute;
            top: 100px;
            right: 30px;
            width: 260px;
            z-index: 90;
            padding: 15px;
            transition: transform 0.4s ease, opacity 0.4s ease;
        }

        #rankPanel.hidden {
            transform: translateX(300px);
            opacity: 0;
            pointer-events: none;
        }

        /* ç»Ÿè®¡æ•°å­— */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-card { background: rgba(255,255,255,0.03); padding: 10px; border-radius: 6px; text-align: center; }
        .stat-card .val { font-size: 18px; color: #fff; font-weight: bold; display: block; }
        .stat-card .lbl { font-size: 10px; color: #888; }

        /* SVG å›¾è¡¨æ ·å¼ */
        .chart-container {
            width: 100%;
            height: 120px;
            margin: 10px 0;
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
            position: relative;
        }
        
        svg { width: 100%; height: 100%; overflow: visible; }
        .line-path { fill: none; stroke: var(--primary-color); stroke-width: 2; vector-effect: non-scaling-stroke; }
        .area-path { fill: rgba(0, 243, 255, 0.1); stroke: none; }
        .grid-line { stroke: rgba(255,255,255,0.05); stroke-width: 1; }
        
        /* æŠ€èƒ½æ¡ */
        .skill-row { display: flex; align-items: center; margin-bottom: 8px; font-size: 12px; }
        .skill-name { width: 60px; color: #aaa; }
        .skill-bar-bg { flex: 1; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; }
        .skill-bar-fill { height: 100%; background: var(--primary-color); border-radius: 3px; width: 0; transition: width 1s ease; }

        /* é›·è¾¾å›¾å¤šè¾¹å½¢ */
        .radar-poly { fill: rgba(255, 0, 85, 0.2); stroke: var(--secondary-color); stroke-width: 2; }
        .radar-bg { fill: none; stroke: rgba(255,255,255,0.1); }

        /* æ’è¡Œæ¦œåˆ—è¡¨ */
        .rank-item {
            display: flex; align-items: center; padding: 8px 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05); cursor: pointer; transition: 0.2s;
        }
        .rank-item:hover { background: rgba(255,255,255,0.1); padding-left: 10px; }
        .rank-num { width: 24px; color: #666; font-weight: bold; }
        .rank-num.top3 { color: #ffd700; text-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
        .rank-name { flex: 1; font-size: 13px; }
        .rank-val { color: var(--primary-color); font-family: monospace; }

        /* Tooltip */
        #tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid var(--primary-color);
            color: #fff;
            padding: 10px 15px;
            border-radius: 4px;
            font-size: 13px;
            pointer-events: none;
            z-index: 200;
            display: none;
            white-space: nowrap;
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.2);
        }

        #close-btn {
            position: absolute; top: 10px; right: 10px;
            background: none; border: none; color: #fff; font-size: 18px; cursor: pointer; opacity: 0.6;
        }
        #close-btn:hover { opacity: 1; }
    </style>
</head>
<body>
    <div id="container"></div>

    <div id="header">
        <h1>Global Dev Matrix</h1>
        <div style="font-size: 12px; color: #aaa; margin-bottom: 5px;">å…¨çƒå¼€å‘è€…å¤šç»´æ•°æ®åˆ†æç³»ç»Ÿ</div>
        
        <div class="view-switcher">
            <button class="view-btn active" onclick="switchView('count')">ğŸ‘¥ æ€»é‡è§†å›¾ / Count</button>
            <button class="view-btn" onclick="switchView('growth')">ğŸ“ˆ å¢é•¿è§†å›¾ / Growth</button>
        </div>
    </div>

    <!-- å·¦ä¾§æœç´¢ä¸å›¾ä¾‹ -->
    <div id="leftPanel" class="glass-panel">
        <div class="search-box">
            <input type="text" id="countrySearch" placeholder="ğŸ” Search Country..." autocomplete="off">
        </div>

        <div class="panel-section">
            <div class="panel-title">Overview</div>
            <div class="stat-grid">
                <div class="stat-card">
                    <span class="val">242</span>
                    <span class="lbl">Regions</span>
                </div>
                <div class="stat-card">
                    <span class="val" style="color:var(--growth-color)">+12.8%</span>
                    <span class="lbl">YoY Growth</span>
                </div>
            </div>
        </div>

        <div class="panel-section">
            <div class="panel-title">Color Legend</div>
            <div id="legendList" style="font-size: 12px; line-height: 1.8;"></div>
        </div>
    </div>

    <!-- å·¦ä¸‹è§’ï¼šåŒºåŸŸæ•°æ®æ±‡æ€» -->
    <div id="bottomLeftPanel" class="glass-panel">
        <div class="panel-title">Regional Analysis</div>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Region</th>
                    <th style="text-align:right">Total Devs</th>
                    <th style="text-align:right">Avg Growth</th>
                </tr>
            </thead>
            <tbody id="regionTableBody">
                <!-- JS Populated -->
            </tbody>
        </table>
    </div>

    <!-- å³ä¾§æ’è¡Œæ¦œ (é»˜è®¤æ˜¾ç¤º) -->
    <div id="rankPanel" class="glass-panel">
        <div class="panel-title">Top 10 Hubs</div>
        <div id="rankingList"></div>
    </div>

    <!-- å³ä¾§è¯¦ç»†åˆ†æé¢æ¿ (ç‚¹å‡»è§¦å‘) -->
    <div id="rightPanel" class="glass-panel" style="padding: 20px;">
        <button id="close-btn" onclick="closeDashboard()">Ã—</button>
        <h2 id="dash-title" style="margin: 0 0 5px 0; color: var(--primary-color);">Country Name</h2>
        <div id="dash-continent" style="font-size: 12px; color: #aaa; margin-bottom: 20px;">Continent</div>

        <!-- æ ¸å¿ƒæŒ‡æ ‡ -->
        <div class="stat-grid">
            <div class="stat-card">
                <span class="val" id="dash-count">0</span>
                <span class="lbl">Total Devs</span>
            </div>
            <div class="stat-card">
                <span class="val" id="dash-growth" style="color: var(--growth-color)">0%</span>
                <span class="lbl">Growth Rate</span>
            </div>
            <div class="stat-card">
                <span class="val" id="dash-rank">#0</span>
                <span class="lbl">Global Rank</span>
            </div>
            <div class="stat-card">
                <span class="val" id="dash-score">0.0</span>
                <span class="lbl">Open Score</span>
            </div>
        </div>

        <!-- 5å¹´è¶‹åŠ¿å›¾ -->
        <div class="panel-section">
            <div class="panel-title">5-Year Growth Trend</div>
            <div class="chart-container" id="trendChart">
                <!-- SVG inserted by JS -->
            </div>
        </div>

        <!-- æŠ€æœ¯æ ˆåˆ†å¸ƒ -->
        <div class="panel-section">
            <div class="panel-title">Tech Stack Focus</div>
            <div id="techStackList">
                <!-- JS Populated -->
            </div>
        </div>

        <!-- èƒ½åŠ›é›·è¾¾ -->
        <div class="panel-section">
            <div class="panel-title">Ecosystem Maturity</div>
            <div class="chart-container" style="height: 160px; display: flex; justify-content: center;" id="radarChart">
                <!-- SVG inserted by JS -->
            </div>
        </div>
    </div>

    <div id="tooltip"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <!-- Shader Code -->
    <script id="vertexShader" type="x-shader/x-vertex">
        varying vec3 vNormal;
        void main() {
            vNormal = normalize(normalMatrix * normal);
            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
        }
    </script>
    <script id="fragmentShader" type="x-shader/x-fragment">
        varying vec3 vNormal;
        uniform vec3 glowColor;
        void main() {
            float intensity = pow(0.7 - dot(vNormal, vec3(0, 0, 1.0)), 4.0);
            gl_FragColor = vec4(glowColor, 1.0) * intensity;
        }
    </script>
    <script>
        // --- é…ç½®ä¸å…¨å±€çŠ¶æ€ ---
        const config = {
            colors: {
                Asia: 0xff3333, NorthAmerica: 0x3388ff, Europe: 0x33ff33,
                SouthAmerica: 0xffaa00, Africa: 0xcc33ff, Oceania: 0x00ffff
            },
            colorMap: { 'Asia': 'Asia', 'North America': 'NorthAmerica', 'Europe': 'Europe', 'South America': 'SouthAmerica', 'Africa': 'Africa', 'Oceania': 'Oceania' }
        };
        
        let currentViewMode = 'count'; // 'count' or 'growth'
        let selectedCountry = null;
        
        // --- æ•°æ®ç”Ÿæˆä¸å¢å¼º ---
        // åŸå§‹åŸºç¡€æ•°æ®
        const baseData = [
            { country: 'China', zh:'ä¸­å›½', count: 198.2, lat: 35.8617, lon: 104.1954, continent: 'Asia' },
            { country: 'USA', zh:'ç¾å›½', count: 476.1, lat: 37.0902, lon: -95.7129, continent: 'North America' },
            { country: 'India', zh:'å°åº¦', count: 239.9, lat: 20.5937, lon: 78.9629, continent: 'Asia' },
            { country: 'Germany', zh:'å¾·å›½', count: 95.0, lat: 51.1657, lon: 10.4515, continent: 'Europe' },
            { country: 'UK', zh:'è‹±å›½', count: 98.3, lat: 55.3781, lon: -3.4360, continent: 'Europe' },
            { country: 'Brazil', zh:'å·´è¥¿', count: 80.0, lat: -14.2350, lon: -51.9253, continent: 'South America' },
            { country: 'Canada', zh:'åŠ æ‹¿å¤§', count: 79.6, lat: 56.1304, lon: -106.3468, continent: 'North America' },
            { country: 'France', zh:'æ³•å›½', count: 68.8, lat: 46.2276, lon: 2.2137, continent: 'Europe' },
            { country: 'Russia', zh:'ä¿„ç½—æ–¯', count: 57.1, lat: 61.5240, lon: 105.3188, continent: 'Europe' },
            { country: 'Japan', zh:'æ—¥æœ¬', count: 36.8, lat: 36.2048, lon: 138.2529, continent: 'Asia' },
            { country: 'Australia', zh:'æ¾³å¤§åˆ©äºš', count: 38.0, lat: -25.2744, lon: 133.7751, continent: 'Oceania' },
            { country: 'Indonesia', zh:'å°åº¦å°¼è¥¿äºš', count: 36.6, lat: -0.7893, lon: 113.9213, continent: 'Asia' },
            { country: 'Netherlands', zh:'è·å…°', count: 30.0, lat: 52.1326, lon: 5.2913, continent: 'Europe' },
            { country: 'South Korea', zh:'éŸ©å›½', count: 28.0, lat: 35.9078, lon: 127.7669, continent: 'Asia' },
            { country: 'Nigeria', zh:'å°¼æ—¥åˆ©äºš', count: 17.6, lat: 9.0820, lon: 8.6753, continent: 'Africa' },
            { country: 'Singapore', zh:'æ–°åŠ å¡', count: 15.0, lat: 1.3521, lon: 103.8198, continent: 'Asia' },
            { country: 'Israel', zh:'ä»¥è‰²åˆ—', count: 14.2, lat: 31.0461, lon: 34.8516, continent: 'Asia' },
            { country: 'Sweden', zh:'ç‘å…¸', count: 24.0, lat: 60.1282, lon: 18.6435, continent: 'Europe' }
        ];

        // è‡ªåŠ¨å¢å¼ºæ•°æ®ï¼šæ·»åŠ æ¨¡æ‹Ÿçš„å†å²è¶‹åŠ¿ã€æŠ€èƒ½åˆ†å¸ƒç­‰
        const fullData = baseData.map((item, idx) => {
            // æ¨¡æ‹Ÿå¢é•¿ç‡ (å‘å±•ä¸­å›½å®¶é€šå¸¸æ›´é«˜)
            const isEmerging = ['Asia', 'Africa', 'South America'].includes(item.continent) && item.country !== 'Japan';
            const growthRate = isEmerging ? (10 + Math.random() * 20) : (2 + Math.random() * 8);
            
            // æ¨¡æ‹Ÿ 5å¹´ å†å²æ•°æ®
            const history = [];
            let current = item.count;
            for(let i=0; i<5; i++) {
                history.unshift(current);
                current = current / (1 + (growthRate + Math.random()*2)/100);
            }

            // æ¨¡æ‹ŸæŠ€èƒ½åˆ†å¸ƒ
            const skills = [
                { name: 'Web', val: 30 + Math.random() * 30 },
                { name: 'AI/ML', val: 10 + Math.random() * 20 },
                { name: 'Cloud', val: 15 + Math.random() * 20 },
                { name: 'Mobile', val: 10 + Math.random() * 15 },
                { name: 'Data', val: 10 + Math.random() * 15 }
            ];
            // å½’ä¸€åŒ–æŠ€èƒ½
            const totalSkill = skills.reduce((a,b) => a + b.val, 0);
            skills.forEach(s => s.val = (s.val / totalSkill * 100).toFixed(1));

            return {
                ...item,
                rank: idx + 1, // åˆå§‹å‡æ’åï¼Œåé¢ä¼šé‡æ’
                growthRate: growthRate.toFixed(1),
                history: history.map(v => parseFloat(v.toFixed(1))),
                skills: skills.sort((a,b) => b.val - a.val),
                score: (8.0 + Math.random() * 1.9).toFixed(1), // å¼€æºè´¡çŒ®è¯„åˆ†
                colorHex: config.colors[config.colorMap[item.continent]]
            };
        });

        // æŒ‰æ•°é‡æ’åº
        fullData.sort((a,b) => b.count - a.count);
        fullData.forEach((d, i) => d.rank = i + 1);

        // --- Three.js åˆå§‹åŒ– ---
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x050510, 0.0025);

        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 3.8;

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.getElementById('container').appendChild(renderer.domElement);

        const earthGroup = new THREE.Group();
        scene.add(earthGroup);

        // 1. åœ°çƒ
        const loader = new THREE.TextureLoader();
        const earthMesh = new THREE.Mesh(
            new THREE.SphereGeometry(1, 64, 64),
            new THREE.MeshPhongMaterial({
                map: loader.load('https://threejs.org/examples/textures/planets/earth_atmos_2048.jpg'),
                specularMap: loader.load('https://threejs.org/examples/textures/planets/earth_specular_2048.jpg'),
                normalMap: loader.load('https://threejs.org/examples/textures/planets/earth_normal_2048.jpg'),
                shininess: 5,
                specular: new THREE.Color(0x333333)
            })
        );
        earthGroup.add(earthMesh);

        // 2. å¤§æ°” Shader
        const atmosMat = new THREE.ShaderMaterial({
            uniforms: { glowColor: { value: new THREE.Color(0x00aaff) } },
            vertexShader: document.getElementById('vertexShader').textContent,
            fragmentShader: document.getElementById('fragmentShader').textContent,
            side: THREE.BackSide,
            blending: THREE.AdditiveBlending,
            transparent: true
        });
        const atmos = new THREE.Mesh(new THREE.SphereGeometry(1.25, 64, 64), atmosMat);
        scene.add(atmos);

        // 3. æ•°æ®æŸ±ä½“
        const bars = [];
        const hitObjects = []; // äº¤äº’å¯¹è±¡
        const maxCount = fullData[0].count;
        const maxGrowth = Math.max(...fullData.map(d => parseFloat(d.growthRate)));

        function latLonToVec3(lat, lon, radius) {
            const phi = (90 - lat) * (Math.PI / 180);
            const theta = (lon + 90) * (Math.PI / 180);
            const x = -(radius * Math.sin(phi) * Math.cos(theta));
            const z = (radius * Math.sin(phi) * Math.sin(theta));
            const y = (radius * Math.cos(phi));
            return new THREE.Vector3(x, y, z);
        }

        fullData.forEach(data => {
            // ä½¿ç”¨å…­è¾¹å½¢æŸ±ä½“ä»£æ›¿æ–¹å—ï¼Œæ›´æœ‰ç§‘æŠ€æ„Ÿ
            // CylinderGeometry(radiusTop, radiusBottom, height, radialSegments)
            // åŠå¾„ä» 0.02 å¢åŠ åˆ° 0.015 (ç›´å¾„çº¦0.03)ï¼Œå¹¶ä½¿ç”¨6è¾¹å½¢
            const barGeo = new THREE.CylinderGeometry(0.015, 0.015, 1, 6);
            
            // è°ƒæ•´å‡ ä½•ä½“æ–¹å‘ï¼šé»˜è®¤æ˜¯Yè½´æœä¸Šï¼Œæˆ‘ä»¬éœ€è¦å®ƒæ²¿ç€Zè½´æœå‘å¤–é¢
            barGeo.rotateX(Math.PI / 2); 
            // è°ƒæ•´é”šç‚¹ï¼šå°†ä¸­å¿ƒä»(0,0,0)ç§»åŠ¨åˆ°Zè½´æ­£æ–¹å‘çš„0.5å¤„ï¼Œè¿™æ ·åº•é¢å°±åœ¨(0,0,0)
            barGeo.translate(0, 0, 0.5);

            const material = new THREE.MeshPhongMaterial({ 
                color: data.colorHex,
                transparent: true,
                opacity: 0.9,
                shininess: 30,
                emissive: data.colorHex,
                emissiveIntensity: 0.3
            });
            const bar = new THREE.Mesh(barGeo, material);
            
            const pos = latLonToVec3(data.lat, data.lon, 1.0);
            bar.position.copy(pos);
            bar.lookAt(0,0,0);

            // è®¡ç®—è¯¥æ¨¡å¼ä¸‹çš„é«˜åº¦ - å¢åŠ é«˜åº¦ç³»æ•°è®©æŸ±å­æ›´æ˜æ˜¾ (0.8 -> 1.2)
            const heightCount = (data.count / maxCount) * 1.2 + 0.05;
            const heightGrowth = (data.growthRate / maxGrowth) * 1.2 + 0.05;

            bar.userData = { 
                data: data,
                heightCount: heightCount,
                heightGrowth: heightGrowth,
                targetHeight: heightCount, // å½“å‰ç›®æ ‡é«˜åº¦
                currentHeight: 0 // åŠ¨ç”»èµ·å§‹
            };
            
            bar.scale.z = 0.01; // åˆå§‹ä¸º0
            earthGroup.add(bar);
            bars.push(bar);

            // ç‚¹å‡»çƒ­åŒº (éšå½¢å¤§çƒä½“ï¼Œæ–¹ä¾¿ç‚¹å‡»)
            const hitGeo = new THREE.SphereGeometry(0.04, 8, 8);
            const hitMat = new THREE.MeshBasicMaterial({ visible: false });
            const hitSphere = new THREE.Mesh(hitGeo, hitMat);
            hitSphere.position.copy(latLonToVec3(data.lat, data.lon, 1.02));
            hitSphere.userData = { linkedBar: bar };
            earthGroup.add(hitSphere);
            hitObjects.push(hitSphere);
        });

        // 4. ç¯å…‰
        scene.add(new THREE.AmbientLight(0x404040));
        const sun = new THREE.DirectionalLight(0xffffff, 1.5);
        sun.position.set(5, 3, 5);
        scene.add(sun);
        const blueLight = new THREE.PointLight(0x0044ff, 2, 10);
        blueLight.position.set(-2, 0, -2);
        scene.add(blueLight);

        // --- äº¤äº’é€»è¾‘ ---
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        let isDragging = false, previousMousePosition = { x: 0, y: 0 };
        let targetRotation = { x: 0, y: 0 };
        let autoRotate = true;

        // é¼ æ ‡äº‹ä»¶
        window.addEventListener('mousemove', e => {
            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
            
            // Tooltip è·Ÿéš
            const tooltip = document.getElementById('tooltip');
            if (tooltip.style.display === 'block') {
                tooltip.style.left = (e.clientX + 15) + 'px';
                tooltip.style.top = (e.clientY + 15) + 'px';
            }
        });

        document.addEventListener('mousedown', () => { isDragging = true; autoRotate = false; });
        document.addEventListener('mouseup', () => isDragging = false);
        
        document.addEventListener('mousemove', e => {
            if (isDragging) {
                const deltaMove = {
                    x: e.offsetX - previousMousePosition.x,
                    y: e.offsetY - previousMousePosition.y
                };
                targetRotation.y += deltaMove.x * 0.005;
                targetRotation.x += deltaMove.y * 0.005;
            }
            previousMousePosition = { x: e.offsetX, y: e.offsetY };
        });

        document.addEventListener('click', e => {
            if (isDragging) return; // æ‹–åŠ¨æ—¶ä¸è§¦å‘ç‚¹å‡»
            if (e.target.closest('.glass-panel') || e.target.closest('.view-switcher')) return; // UI ç‚¹å‡»å¿½ç•¥

            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(hitObjects);

            if (intersects.length > 0) {
                const bar = intersects[0].object.userData.linkedBar;
                selectCountry(bar);
            } else {
                // closeDashboard(); // ç‚¹å‡»ç©ºç™½å¤„æ˜¯å¦å…³é—­ï¼Ÿæš‚æ—¶ä¿ç•™
            }
        });
        // --- åŠŸèƒ½å‡½æ•° ---

        function switchView(mode) {
            currentViewMode = mode;
            // æ›´æ–°æŒ‰é’®æ ·å¼
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // æ›´æ–°æŸ±ä½“
            bars.forEach(bar => {
                const data = bar.userData.data;
                // é¢œè‰²åˆ‡æ¢
                let targetColor = data.colorHex;
                if (mode === 'growth') {
                    // å¢é•¿ç‡çƒ­åŠ›å›¾ï¼šçº¢è‰²(ä½) -> ç»¿è‰²(é«˜)
                    const g = parseFloat(data.growthRate);
                    const t = Math.min(Math.max((g - 2) / 20, 0), 1); // å½’ä¸€åŒ– 2%~22%
                    const color = new THREE.Color().setHSL(t * 0.35, 1.0, 0.5); // HSL 0(Red) to 0.35(Green)
                    targetColor = color.getHex();
                } else {
                    targetColor = data.colorHex; // æ¢å¤å¤§æ´²é¢œè‰²
                }
                
                bar.material.color.setHex(targetColor);
                bar.material.emissive.setHex(targetColor); // æ›´æ–°è‡ªå‘å…‰é¢œè‰²
                
                // é«˜åº¦ç›®æ ‡åˆ‡æ¢
                bar.userData.targetHeight = mode === 'growth' ? bar.userData.heightGrowth : bar.userData.heightCount;
            });
        }

        function selectCountry(bar) {
            const data = bar.userData.data;
            selectedCountry = data;
            
            // 1. åœ°çƒæ—‹è½¬å®šä½
            autoRotate = false;
            const spherical = new THREE.Spherical().setFromVector3(bar.position);
            targetRotation.y = -spherical.theta - Math.PI / 2;
            targetRotation.x = Math.PI / 2 - spherical.phi;

            // 2. æ›´æ–°é¢æ¿å†…å®¹
            openDashboard(data);
        }

        // --- å›¾è¡¨ç”Ÿæˆå™¨ (SVG) ---

        function createTrendChart(history) {
            const w = 280, h = 100;
            const max = Math.max(...history) * 1.1;
            const min = Math.min(...history) * 0.9;
            const points = history.map((val, i) => {
                const x = (i / (history.length - 1)) * w;
                const y = h - ((val - min) / (max - min)) * h;
                return `${x},${y}`;
            }).join(' ');

            // ç”Ÿæˆé¢ç§¯é—­åˆè·¯å¾„
            const areaPoints = `0,${h} ${points} ${w},${h}`;

            return `
                <svg viewBox="0 0 ${w} ${h}">
                    <defs>
                        <linearGradient id="grad" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:var(--primary-color);stop-opacity:0.3" />
                            <stop offset="100%" style="stop-color:var(--primary-color);stop-opacity:0" />
                        </linearGradient>
                    </defs>
                    <path class="area-path" d="M${areaPoints} Z" fill="url(#grad)" />
                    <polyline points="${points}" class="line-path" />
                    <!-- æ•°æ®ç‚¹ -->
                    ${history.map((val, i) => {
                         const x = (i / (history.length - 1)) * w;
                         const y = h - ((val - min) / (max - min)) * h;
                         return `<circle cx="${x}" cy="${y}" r="3" fill="#fff" />`;
                    }).join('')}
                </svg>
            `;
        }

        function createRadarChart(skills) {
            const size = 140;
            const center = size / 2;
            const radius = size / 2 - 10;
            const sides = skills.length;
            
            // è®¡ç®—åæ ‡å‡½æ•°
            const getPoint = (idx, value) => {
                const angle = (Math.PI * 2 * idx) / sides - Math.PI / 2;
                const r = (value / 100) * radius;
                return {
                    x: center + r * Math.cos(angle),
                    y: center + r * Math.sin(angle)
                };
            };

            // ç”Ÿæˆç½‘æ ¼
            let gridSVG = '';
            [0.2, 0.4, 0.6, 0.8, 1.0].forEach(level => {
                const pts = skills.map((_, i) => {
                    const p = getPoint(i, level * 100);
                    return `${p.x},${p.y}`;
                }).join(' ');
                gridSVG += `<polygon points="${pts}" class="radar-bg" />`;
            });

            // æ•°æ®å¤šè¾¹å½¢
            const dataPoints = skills.map((s, i) => {
                const p = getPoint(i, s.val);
                return `${p.x},${p.y}`;
            }).join(' ');

            // è½´çº¿ä¸æ ‡ç­¾
            const axesSVG = skills.map((s, i) => {
                const p = getPoint(i, 115); // æ ‡ç­¾ä½ç½®
                return `<text x="${p.x}" y="${p.y}" fill="#888" font-size="10" text-anchor="middle" alignment-baseline="middle">${s.name}</text>`;
            }).join('');

            return `
                <svg viewBox="0 0 ${size} ${size}">
                    ${gridSVG}
                    <polygon points="${dataPoints}" class="radar-poly" />
                    ${axesSVG}
                </svg>
            `;
        }

        // --- UI æ›´æ–°é€»è¾‘ ---

        function openDashboard(data) {
            document.getElementById('dash-title').innerText = data.country;
            document.getElementById('dash-continent').innerText = data.continent;
            document.getElementById('dash-count').innerText = data.count + 'ä¸‡';
            document.getElementById('dash-growth').innerText = '+' + data.growthRate + '%';
            document.getElementById('dash-rank').innerText = '#' + data.rank;
            document.getElementById('dash-score').innerText = data.score;

            // æ¸²æŸ“å›¾è¡¨
            document.getElementById('trendChart').innerHTML = createTrendChart(data.history);
            
            // æ¸²æŸ“æŠ€èƒ½æ¡
            const techHTML = data.skills.map(s => `
                <div class="skill-row">
                    <span class="skill-name">${s.name}</span>
                    <div class="skill-bar-bg">
                        <div class="skill-bar-fill" style="width: ${s.val}%"></div>
                    </div>
                    <span style="margin-left:5px; width:30px; text-align:right;">${Math.round(s.val)}%</span>
                </div>
            `).join('');
            document.getElementById('techStackList').innerHTML = techHTML;

            // æ¸²æŸ“é›·è¾¾å›¾
            document.getElementById('radarChart').innerHTML = createRadarChart(data.skills);

            // åŠ¨ç”»åˆ‡æ¢é¢æ¿
            document.getElementById('rankPanel').classList.add('hidden');
            document.getElementById('rightPanel').classList.add('active');
        }

        function closeDashboard() {
            document.getElementById('rankPanel').classList.remove('hidden');
            document.getElementById('rightPanel').classList.remove('active');
            autoRotate = true; // æ¢å¤æ—‹è½¬
        }
        
        // --- æ¸²æŸ“å·¦ä¸‹è§’å¤§æ´²ç»Ÿè®¡è¡¨ ---
        function renderRegionTable() {
            // èšåˆæ•°æ®
            const regionStats = {};
            fullData.forEach(d => {
                if(!regionStats[d.continent]) {
                    regionStats[d.continent] = { count: 0, growthSum: 0, num: 0 };
                }
                regionStats[d.continent].count += d.count;
                regionStats[d.continent].growthSum += parseFloat(d.growthRate);
                regionStats[d.continent].num++;
            });
            
            const tbody = document.getElementById('regionTableBody');
            
            // æ’åºï¼šæŒ‰æ€»äººæ•°é™åº
            const sortedRegions = Object.keys(regionStats).sort((a,b) => regionStats[b].count - regionStats[a].count);
            
            sortedRegions.forEach(r => {
                const s = regionStats[r];
                const avgGrowth = (s.growthSum / s.num).toFixed(1);
                const totalCount = s.count.toFixed(1);
                
                // é¢œè‰²
                const colorHex = config.colors[config.colorMap[r]];
                const colorStr = '#' + colorHex.toString(16).padStart(6, '0');
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><span style="color:${colorStr}; margin-right:5px;">â—</span>${r}</td>
                    <td class="num">${totalCount}M</td>
                    <td class="num ${avgGrowth > 10 ? 'trend-up' : 'trend-neutral'}">+${avgGrowth}%</td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        renderRegionTable(); // å¯åŠ¨æ—¶è°ƒç”¨

        window.closeDashboard = closeDashboard;
        window.switchView = switchView;

        // åˆå§‹åŒ–æ’è¡Œæ¦œ
        const rankList = document.getElementById('rankingList');
        fullData.slice(0, 10).forEach(d => {
            const div = document.createElement('div');
            div.className = 'rank-item';
            div.innerHTML = `
                <span class="rank-num ${d.rank<=3?'top3':''}">${d.rank}</span>
                <span class="rank-name">${d.country}</span>
                <span class="rank-val">${d.count}ä¸‡</span>
            `;
            div.onclick = () => {
                const bar = bars.find(b => b.userData.data === d);
                if(bar) selectCountry(bar);
            };
            rankList.appendChild(div);
        });

        // åˆå§‹åŒ–å›¾ä¾‹
        const legendDiv = document.getElementById('legendList');
        Object.keys(config.colorMap).forEach(k => {
            const color = '#' + config.colors[config.colorMap[k]].toString(16).padStart(6,'0');
            legendDiv.innerHTML += `<span style="color:${color}">â—</span> ${k} <br>`;
        });

        // æœç´¢åŠŸèƒ½
        document.getElementById('countrySearch').addEventListener('change', (e) => {
            const val = e.target.value.toLowerCase();
            const found = bars.find(b => b.userData.data.country.toLowerCase().includes(val) || b.userData.data.zh.includes(val));
            if(found) selectCountry(found);
            else alert('Country not found in top database.');
        });

        // --- æ¸²æŸ“å¾ªç¯ ---
        function animate() {
            requestAnimationFrame(animate);

            // 1. æ—‹è½¬æ§åˆ¶
            if(autoRotate) targetRotation.y += 0.001;
            
            earthGroup.rotation.y += (targetRotation.y - earthGroup.rotation.y) * 0.05;
            earthGroup.rotation.x += (targetRotation.x - earthGroup.rotation.x) * 0.05;

            // 2. æŸ±ä½“åŠ¨ç”» (Lerp height)
            bars.forEach(bar => {
                bar.userData.currentHeight += (bar.userData.targetHeight - bar.userData.currentHeight) * 0.1;
                bar.scale.z = bar.userData.currentHeight;
            });

            // 3. å°„çº¿æ£€æµ‹ Tooltip
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(hitObjects);
            
            const tooltip = document.getElementById('tooltip');
            if (intersects.length > 0 && !isDragging) {
                const data = intersects[0].object.userData.linkedBar.userData.data;
                document.body.style.cursor = 'pointer';
                tooltip.innerHTML = `<strong>${data.country}</strong><br>Devs: ${data.count}M<br>Growth: +${data.growthRate}%`;
                tooltip.style.display = 'block';
            } else {
                document.body.style.cursor = 'default';
                tooltip.style.display = 'none';
            }

            renderer.render(scene, camera);
        }

        animate();

        // çª—å£è‡ªé€‚åº”
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
